<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>Setup GlusterFS with Distributed Replicated Volumes and Native client</title>

    <link rel="stylesheet" href="http://localhost:8000/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://localhost:8000/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://localhost:8000/theme/css/style.css" />
    <link rel="stylesheet" href="http://localhost:8000/theme/css/pygments.css" />	
    <script src="http://localhost:8000/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://localhost:8000">gatieme</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://localhost:8000/articles/setup-glusterfs-with-distributed-replicated-volumes-and-native-client.html" rel="bookmark"
        title="Permalink to Setup GlusterFS with Distributed Replicated Volumes and Native client">Setup GlusterFS with Distributed Replicated Volumes and Native client</a></h3>
    </header>

<h6 class="subheader" title="2014-09-26T15:39:00+08:00">2014-09-26
</h6>


    <p><strong>OS: </strong> CentOS 6.4 x86_64 Minimal</p>
<h4>1. Install packages, on idc1-server{1-4}:</h4>
<p><code># wget -P /etc/yum.repos.d http://download.gluster.org/pub/gluster/glusterfs/LATEST/CentOS/glusterfs-epel.repo</code></p>
<p><code># yum install -y glusterfs glusterfs-server glusterfs-fuse</code></p>
<p><code># /etc/init.d/glusterd start</code></p>
<p><code># chkconfig glusterd on</code></p>
<h4>2. Configure peers, just on idc1-server1:</h4>
<p><code>[root@idc1-server1 ~]# gluster peer probe idc1-server2</code></p>
<div class="highlight"><pre><span></span>peer probe: success
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster peer probe idc1-server3</code></p>
<div class="highlight"><pre><span></span>peer probe: success
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster peer probe idc1-server4</code></p>
<div class="highlight"><pre><span></span>peer probe: success
</pre></div>


<p><strong>NOTE:</strong></p>
<p>The following step is very important with the version 3.4.3!</p>
<p>If configured all peers with hostname on one host, must remember to recreate the peer of this host on another host.</p>
<p>Otherwise all other hosts cannot recognize this host by hostname.
10.1.1.35 is the ip address of idc1-server1, detach it then probe with hostname.</p>
<p>Just on idc1-server2:</p>
<p><code>[root@idc1-server2 ~]# gluster peer detach 10.1.1.35</code></p>
<div class="highlight"><pre><span></span>peer detach: success
</pre></div>


<p><code>[root@idc1-server2 ~]# gluster peer probe idc1-server1</code></p>
<div class="highlight"><pre><span></span>peer probe: success
</pre></div>


<p>Just on idc1-server2:</p>
<p><code>[root@idc1-server2 ~]# gluster peer status</code></p>
<div class="highlight"><pre><span></span>Number of Peers: 3

Hostname: idc1-server3
Uuid: 01f25251-9ee6-40c7-a322-af53a034aa5a
State: Peer in Cluster (Connected)

Hostname: idc1-server4
Uuid: 212295a6-1f38-4a1e-968c-577241318ff1
State: Peer in Cluster (Connected)

Hostname: idc1-server1
Port: 24007
Uuid: ed016c4e-7159-433f-88a5-5c3ebd8e36c9
State: Peer in Cluster (Connected)
</pre></div>


<h4>3. Create directories, on idc1-server{1-4}:</h4>
<p><code># mkdir -p /usr/local/share/{datavolume1,datavolume2,datavolume3}</code></p>
<p><code># chown -R root:root /mnt/{datavolume1,datavolume2,datavolume3}</code></p>
<p><code># ls -l /usr/local/share/</code></p>
<div class="highlight"><pre><span></span>total 24
drwxr-xr-x.  2 root root 4096 Sep 23  2011 applications
drwxr-xr-x   2 root root 4096 Apr  1 12:19 datavolume2
drwxr-xr-x.  2 root root 4096 Sep 23  2011 info
drwxr-xr-x. 21 root root 4096 Feb 20  2013 man
drwxr-xr-x   2 root root 4096 Apr  1 12:19 datavolume1
drwxr-xr-x   2 root root 4096 Apr  1 12:19 datavolume3
</pre></div>


<h4>4. Create Distributed Replicated Volumes, just on idc1-server1:</h4>
<p><code>[root@idc1-server1 ~]# gluster volume create datavolume1 replica 2 transport tcp idc1-server1:/usr/local/share/datavolume1 idc1-server2:/usr/local/share/datavolume1 idc1-server3:/usr/local/share/datavolume1 idc1-server4:/usr/local/share/datavolume1 force</code></p>
<div class="highlight"><pre><span></span>volume create: datavolume1: success: please start the volume to access data
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster volume create datavolume2 replica 2 transport tcp idc1-server1:/usr/local/share/datavolume2 idc1-server2:/usr/local/share/datavolume2 idc1-server3:/usr/local/share/datavolume2 idc1-server4:/usr/local/share/datavolume2 force</code></p>
<div class="highlight"><pre><span></span>volume create: datavolume2: success: please start the volume to access data
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster volume create datavolume3 replica 2 transport tcp idc1-server1:/usr/local/share/datavolume3 idc1-server2:/usr/local/share/datavolume3 idc1-server3:/usr/local/share/datavolume3 idc1-server4:/usr/local/share/datavolume3 force</code></p>
<div class="highlight"><pre><span></span>volume create: datavolume3: success: please start the volume to access data
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster volume start datavolume1</code></p>
<div class="highlight"><pre><span></span>volume start: datavolume1: success
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster volume start datavolume2</code></p>
<div class="highlight"><pre><span></span>volume start: datavolume2: success
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster volume start datavolume3</code></p>
<div class="highlight"><pre><span></span>volume start: datavolume3: success
</pre></div>


<p><code>[root@idc1-server1 ~]# gluster volume info</code></p>
<div class="highlight"><pre><span></span>Volume Name: datavolume1
Type: Distributed-Replicate
Volume ID: aea76c2a-b754-4037-9634-c2062e2955c3
Status: Started
Number of Bricks: 2 x 2 = 4
Transport-type: tcp
Bricks:
Brick1: idc1-server1:/usr/local/share/datavolume1
Brick2: idc1-server2:/usr/local/share/datavolume1
Brick3: idc1-server3:/usr/local/share/datavolume1
Brick4: idc1-server4:/usr/local/share/datavolume1

Volume Name: datavolume2
Type: Distributed-Replicate
Volume ID: 1ed65c6e-ee23-475a-82c7-2967e2fc2569
Status: Started
Number of Bricks: 2 x 2 = 4
Transport-type: tcp
Bricks:
Brick1: idc1-server1:/usr/local/share/datavolume2
Brick2: idc1-server2:/usr/local/share/datavolume2
Brick3: idc1-server3:/usr/local/share/datavolume2
Brick4: idc1-server4:/usr/local/share/datavolume2

Volume Name: datavolume3
Type: Distributed-Replicate
Volume ID: b63bb4ea-bd37-4dd6-9a4c-230e6d236afa
Status: Started
Number of Bricks: 2 x 2 = 4
Transport-type: tcp
Bricks:
Brick1: idc1-server1:/usr/local/share/datavolume3
Brick2: idc1-server2:/usr/local/share/datavolume3
Brick3: idc1-server3:/usr/local/share/datavolume3
Brick4: idc1-server4:/usr/local/share/datavolume3
</pre></div>


<h4>5. Configure the Network ACL, just on idc1-server1:</h4>
<p><code>[root@idc1-server1 ~]# gluster volume set datavolume1 auth.allow 10.1.1.*,10.1.2.*</code></p>
<h4>6. Tests on idc1-client15, install the version '-3.4.0.57rhs-1.el6_5' which supports option: 'backup-volfile-servers'</h4>
<p><code>[root@idc1-client15 ~]# yum install -y glusterfs-3.4.0.57rhs-1.el6_5 glusterfs-libs-3.4.0.57rhs-1.el6_5 glusterfs-fuse-3.4.0.57rhs-1.el6_5</code></p>
<p><code>[root@idc1-client15 ~]# mkdir -p /mnt/{datavolume1,datavolume2,datavolume3}</code></p>
<p><code>[root@idc1-client15 ~]# chown -R root:root /mnt/{datavolume1,datavolume2,datavolume3}</code></p>
<p><code>[root@idc1-client15 ~]# mount -t glusterfs -o backup-volfile-servers=idc1-server2:idc1-server3:idc1-server4,ro idc1-server1:datavolume1 /mnt/datavolume1/</code></p>
<p><code>[root@idc1-client15 ~]# mount -t glusterfs -o backup-volfile-servers=idc1-server2:idc1-server3:idc1-server4,ro idc1-server1:datavolume2 /mnt/datavolume2/</code></p>
<p><code>[root@idc1-client15 ~]# mount -t glusterfs -o backup-volfile-servers=idc1-server2:idc1-server3:idc1-server4,ro idc1-server1:datavolume3 /mnt/datavolume3/</code></p>
<p><code>[root@idc1-client15 ~]# df -h</code></p>
<div class="highlight"><pre><span></span>Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/vg_t-lv_root
                       59G  7.7G   48G  14% /
tmpfs                 3.9G     0  3.9G   0% /dev/shm
/dev/xvda1            485M   33M  428M   8% /boot
idc1-server3:datavolume1     98G  8.6G   85G  10% /mnt/datavolume1
idc1-server3:datavolume2     98G  8.6G   85G  10% /mnt/datavolume2
idc1-server3:datavolume3     98G  8.6G   85G  10% /mnt/datavolume3
</pre></div>


<p><strong>Tests:</strong></p>
<p>Write on idc1-client15 mount point /mnt/datavolume1:</p>
<p><code>[root@idc1-client15 ~]# umount /mnt/datavolume1</code></p>
<p><code>[root@idc1-client15 ~]# mount -t glusterfs idc1-server3:datavolume1 /mnt/datavolume1/</code></p>
<p><code>[root@idc1-client15 ~]# echo "This is idc1-client15" &gt; /mnt/datavolume1/hello.txt</code></p>
<p><code>[root@idc1-client15 ~]# mkdir /mnt/testdir</code></p>
<p><code>[root@idc1-server1 ~]# ls /usr/local/share/datavolume1/</code></p>
<div class="highlight"><pre><span></span>hello.txt testdir
</pre></div>


<p>Saw hello.txt and testdir</p>
<p>Write on idc1-server1 volumes dir /usr/local/share/datavolume1:</p>
<p><code>[root@idc1-server1 ~]# echo "This is idc1-server1" &gt; /usr/local/share/datavolume1/hello.2.txt</code></p>
<p><code>[root@idc1-server1 ~]# mkdir /usr/local/share/datavolume1/test2</code></p>
<p><code>[root@idc1-client15 ~]# ls /mnt/datavolume1</code></p>
<p><code>[root@idc1-client15 datavolume1]# ls -l /mnt/datavolume1</code></p>
<div class="highlight"><pre><span></span>hello.txt testdir
</pre></div>


<p>Didn't see hello.2.txt and test2</p>
<p>Write on idc1-server1 mount point /mnt/datavolume1:</p>
<p><code>[root@idc1-server1 ~]# mount -t glusterfs idc1-server1:datavolume1 /mnt/datavolume1/</code></p>
<p><code>[root@idc1-server1 ~]# echo "This is idc1-server1" &gt; /mnt/datavolume1/hello.3.txt</code></p>
<p><code>[root@idc1-server1 ~]# mkdir /mnt/datavolume1/test3</code></p>
<p><code>[root@idc1-client15 datavolume1]# ls /mnt/datavolume1</code></p>
<div class="highlight"><pre><span></span>hello.2.txt  hello.3.txt hello.txt  test2  test3  testdir
</pre></div>


<p>Saw hello.3.txt and test3, and the hello.2.txt and test2 also.</p>
<p>So I guess if we just write or delete file outside the mount point, it doesn't notify other nodes, so the changes didn't take effect.
We should mount it on all servers which we want to write or delete files.</p>
<p><strong>Other Notes:</strong></p>
<p>Delete:</p>
<p><code># gluster volume stop datavolume1</code></p>
<p><code># gluster volume delete datavolume1</code></p>
<p>Move:</p>
<p><code># gluster peer detach idc1-server4</code></p>
<p>ACL:</p>
<p><code># gluster volume set datavolume1 auth.allow 10.1.1.*,10.1.2.*</code></p>
<p>Add:</p>
<p><code># gluster peer probe idc1-server5</code></p>
<p><code># gluster peer probe idc1-server6</code></p>
<p><code># gluster volume add-brick datavolume1 idc1-server5:/usr/local/share/datavolume1 idc1-server6:/usr/local/share/datavolume1</code></p>
<p>Shrink and migration:</p>
<p><code># gluster volume remove-brick datavolume1 idc1-server1:/usr/local/share/datavolume1 idc1-server5:/usr/local/share/datavolume1 start</code></p>
<p><code># gluster volume remove-brick datavolume1 idc1-server1:/usr/local/share/datavolume1 idc1-server5:/usr/local/share/datavolume1 status</code></p>
<p><code># gluster volume remove-brick datavolume1 idc1-server1:/usr/local/share/datavolume1 idc1-server5:/usr/local/share/datavolume1 commit</code></p>
<p>Rebalance:</p>
<p><code># gluster volume rebalance datavolume1 start</code></p>
<p><code># gluster volume rebalance datavolume1 status</code></p>
<p><code># gluster volume rebalance datavolume1 stop</code></p>
<p>If idc1-server1 dead:</p>
<p><code># gluster volume replace-brick datavolume1 idc1-server1:/usr/local/share/datavolume1 idc1-server5:/usr/local/share/datavolume1 commit -force</code></p>
<p><code># gluster volume heal datavolume1 full</code></p>
<p class="subheader">Category: <a href="http://localhost:8000/category/linuxunix.html">Linux&Unix</a>
    Tagged: 
    <a href="http://localhost:8000/tag/glusterfs.html">GlusterFS </a>
    <a href="http://localhost:8000/tag/distributed.html">Distributed </a>
</p>




	<h4>Comments</h4>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'mcsrainbow'
        var disqus_identifier = "articles/setup-glusterfs-with-distributed-replicated-volumes-and-native-client.html";
        var disqus_url = "http://localhost:8000/articles/setup-glusterfs-with-distributed-replicated-volumes-and-native-client.html";

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://localhost:8000/archives.html">Archives</a>
            <li><a href="http://localhost:8000/tags.html">Tags</a>
        </ul>

		
        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://localhost:8000/category/linuxunix.html">Linux&Unix</a></li>
            <li><a href="http://localhost:8000/category/uncategorized.html">Uncategorized</a></li>
   
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://lxr.free-electrons.com/">LXR</a></li>
            <li><a href="http://www.nowcoder.com/contestRoom">牛客</a></li>
        </ul>
		
        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="https://github.com/gatieme">github</a></li>
            <li><a href="http://stackoverflow.com/users/4935308/gatieme">stackoverflow</a></li>
            <li><a href="http://blog.csdn.net/gatieme">csdn</a></li>
            <li><a href="https://twitter.com/gatieme">twitter</a></li>
            <li><a href="https://www.facebook.com/gatieme">facebook</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
                    <p><a href="https://github.com/getpelican/pelican-themes/tree/master/zurb-F5-basic">ZurbFoundation5</a> Theme | Powered by <a href="http://docs.getpelican.com/">Pelican</a><p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></br></a>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0 </a>.            </div>
            </div>
    </div>
</footer>
<a href="https://github.com/gatieme/gatieme.github.io">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2345097-6', 'auto');
  ga('send', 'pageview');

</script></body>
</html>